---
title: "week3 Kamloops heat wave analysis"
output: html_document
date: "2024-05-20"
---
# Data
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("../R/read_data_Kamloops.R")  ## read data
source("../R/data_wrangling.R") ## data wrangling
source("../R/data_for_temp_plot.R") ## Modify the data by normalizing dates for plotting, get the data ready, and a function to plot a given year vs baseline
source("../R/data_for_hw_plot.R")  
source("../R/hw_plot_all_year_temp.R") ## all year in grey, baseline blue
source("../R/hw_plot_overview.R") 
source("../R/heatmap_real.R") 
start_year <- 1951
end_year <- 2024
step <- 40
```




## overview
```{r, echo=FALSE}
summary_stats
missing_values
```
## check wrangling data
```{r, echo=FALSE,results = 'hide'}
# Print a specific row's rolling window
df_wrangling$rolling_window[[1]] # First row
df_wrangling$rolling_window[[5]]  # sample row
df_wrangling$rolling_window[[10]] # sample row
df_wrangling$rolling_window[[nrow(df_wrangling)]] # Last row
```
check temp dist for in a random day from all year value
```{r, echo=FALSE,results = 'show'}
# Check the result
#df_grouped$ROLLING_WINDOW_ALL_YEAR_VALUES[[1]] # First row
#df_grouped$ROLLING_WINDOW_ALL_YEAR_VALUES[[5]]  # sample row
df_grouped$ROLLING_WINDOW_ALL_YEAR_VALUES[[88]] # sample row
#df_grouped$ROLLING_WINDOW_ALL_YEAR_VALUES[[nrow(df_wrangling)]] # Last row
length(df_grouped$ROLLING_WINDOW_ALL_YEAR_VALUES[[88]])
```


get 90th from the all year for all day value
```{r, echo=FALSE,results = 'show'}
# Print the result
df_percentiles$Percentile_90
station_name <- "Kamloops"
df_percentiles <- df_percentiles %>%
  mutate(Station = station_name)


# Select specific columns to save
selected_columns <- df_percentiles %>%
  select(Month,Day,Percentile_90,Station)  # Adjust column names as needed
# Define the path to save the CSV file
save_path <- "../output/Kamloops_percentiles.csv"

## Save the selected columns as a CSV file
write.csv(selected_columns, file = save_path, row.names = FALSE)
```

# Plot

## plot given year temp dist vs baseline 90th

```{r, echo=FALSE}

# Example usage:
df_plot_year <- prepare_plot_data("Percentile_90", 2014, "MAX_TEMPERATURE")
# Example usage:
plot_percentiles_vs_year(df_plot_year,2014)
```

```{r, echo=FALSE,message=FALSE}
# Main function to loop through multiple years
plot_all_years <- function(start_year, end_year) {
  for (year in start_year:end_year) {
    df_plot_year <- prepare_plot_data("Percentile_90", year, "MAX_TEMPERATURE")
    print(plot_percentiles_vs_year(df_plot_year, year))
  }
}
#plot_all_years(2000, 2024)

```



## plot all year temp in grey vs baseline 
```{r, echo=FALSE,message=FALSE}
# Example usage:
#Assuming the range of years is from 2000 to 2024 and the specific year to highlight is 2014

print(plot_all_years_with_baseline(start_year,end_year,2000))


print(plot_all_years_highlight_specific_year(start_year,end_year,2021))
```



## Analyze the hw

## hw dist for certain 1 year

prepare for the data
```{r, echo=FALSE,message=FALSE}
year_analysis_hw <- 2019
df_for_hw <- prepare_plot_data("Percentile_90", year_analysis_hw, "MAX_TEMPERATURE")
process_data_for_hw(df_for_hw)
```


## plot hw analysis for all year

```{r, echo=FALSE,message=FALSE}
# Analysis for each year
# Define the start, end, and step for the sequence


# Generate the sequence of years
years <- seq(start_year, end_year, by = step)

# Loop over the sequence of years
for (year_single in years) {
  df_plot <- prepare_plot_data("Percentile_90", year_single, "MAX_TEMPERATURE")
  summaries <- process_data_by_year(process_data_for_hw(df_plot), year_single)
  plots <- plot_case_summary(summaries, year_single)
  
  print(plots$month_plot)
  print(plots$hw_length_plot)
}

```

## plot overall count of hw through years

```{r, echo=FALSE,message=FALSE}
# Process all years and generate plots
filtered_plot <- process_all_years_and_generate_plots(start_year,1980)

# Print the generated plots
#print(plots$total_plot)
print(filtered_plot)

```

```{r, echo=FALSE,,message=FALSE}
# Process all years and generate plots
filtered_plot <- process_all_years_and_generate_plots(1980,end_year)

# Print the generated plots
print(filtered_plot)
```

## plot for heat map


```{r, echo=FALSE,message=FALSE}
# Assuming you have data frames named df_2021, df_2022, ..., df_2025
# Loop through the years to dynamically add each data frame to the list
 list_of_dfs <- list()
 
 for (year in start_year:end_year) {
   # Assuming `df` is the base data frame, apply the `prepare_heatmap_plot_data` function
   prepared_df <- prepare_heatmap_plot_data(df, "Percentile_90", year, "MAX_TEMPERATURE")
   
   # Add the prepared data frame to the list
   list_of_dfs[[as.character(year)]] <- prepared_df
 }
 # Combine the data frames into one
 combined_df <- do.call(rbind, list_of_dfs)
```

```{r, echo=FALSE,message=FALSE}
heatmap <- create_heatmap(combined_df, "01-01","12-31")
print(heatmap)
 
```


```{r, echo=FALSE,message=FALSE}
heatmap <- create_heatmap(combined_df, "04-01","10-31")
print(heatmap)
 
```
```{r, echo=FALSE,message=FALSE}
heatmap <- create_heatmap_diff(combined_df, "04-01","10-31")
print(heatmap)
```






```{r, echo=FALSE,message=FALSE}
list_of_dfs <- list()

for (year in 1941:1960) {
  # Assuming `df` is the base data frame, apply the `prepare_heatmap_plot_data` function
  prepared_df <- prepare_heatmap_plot_data(df, "Percentile_90", year, "MAX_TEMPERATURE")
  
  # Add the prepared data frame to the list
  list_of_dfs[[as.character(year)]] <- prepared_df
}
# Combine the data frames into one
combined_df <- do.call(rbind, list_of_dfs)

heatmap <- create_heatmap_diff(combined_df, "04-01","10-31")
print(heatmap)


list_of_dfs <- list()
for (year in 1960:1980) {
  # Assuming `df` is the base data frame, apply the `prepare_heatmap_plot_data` function
  prepared_df <- prepare_heatmap_plot_data(df, "Percentile_90", year, "MAX_TEMPERATURE")
  
  # Add the prepared data frame to the list
  list_of_dfs[[as.character(year)]] <- prepared_df
}
# Combine the data frames into one
combined_df <- do.call(rbind, list_of_dfs)

heatmap <- create_heatmap_diff(combined_df, "04-01","10-31")
print(heatmap)

list_of_dfs <- list()
for (year in 1980:2000) {
  # Assuming `df` is the base data frame, apply the `prepare_heatmap_plot_data` function
  prepared_df <- prepare_heatmap_plot_data(df, "Percentile_90", year, "MAX_TEMPERATURE")
  
  # Add the prepared data frame to the list
  list_of_dfs[[as.character(year)]] <- prepared_df
}
# Combine the data frames into one
combined_df <- do.call(rbind, list_of_dfs)

heatmap <- create_heatmap_diff(combined_df, "04-01","10-31")
print(heatmap)



list_of_dfs <- list()
for (year in 2000:2024) {
  # Assuming `df` is the base data frame, apply the `prepare_heatmap_plot_data` function
  prepared_df <- prepare_heatmap_plot_data(df, "Percentile_90", year, "MAX_TEMPERATURE")
  
  # Add the prepared data frame to the list
  list_of_dfs[[as.character(year)]] <- prepared_df
}
# Combine the data frames into one
combined_df <- do.call(rbind, list_of_dfs)

heatmap <- create_heatmap_diff(combined_df, "04-01","10-31")
print(heatmap)
 
```





## examine specific year
```{r, echo=FALSE,message=FALSE}
# Define the specific years you want to process
years_to_process <- c(1952,1958,1961,1969,1977,1980,1981,1982,2005, 2009, 2021)

# Initialize an empty list to store data frames for each year
list_of_dfs <- list()
  
for (year in years_to_process) {
  # Assuming `df` is the base data frame, apply the `prepare_heatmap_plot_data` function
  prepared_df <- prepare_heatmap_plot_data(df, "Percentile_90", year, "MAX_TEMPERATURE")
  
  # Add the prepared data frame to the list
  list_of_dfs[[as.character(year)]] <- prepared_df
}
# Combine the data frames into one
combined_df <- do.call(rbind, list_of_dfs)

heatmap <- create_heatmap_diff(combined_df, "04-01","10-31")
print(heatmap)

for (year in years_to_process) {
  print(plot_all_years_highlight_specific_year(start_year,end_year,year))
}
```


```{r, echo=FALSE,message=FALSE}
# Loop over the sequence of years
years_to_process <- c(1952,1958,1961,1969,1977,1980,1981,1982,2005, 2009, 2021)

for (year_single in years_to_process) {
  df_plot <- prepare_plot_data("Percentile_90", year_single, "MAX_TEMPERATURE")
  summaries <- process_data_by_year(process_data_for_hw(df_plot), year_single)
  plots <- plot_case_summary(summaries, year_single)
  
  print(plots$month_plot)
  print(plots$hw_length_plot)
}
```