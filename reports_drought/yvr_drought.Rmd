---
title: "Dry peroiods analysis"
author: "alex lin "
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---
<script>
function toggleCollapsible(section) {
  var content = section.nextElementSibling;
  if (content.style.display === "none") {
    content.style.display = "block";
  } else {
    content.style.display = "none";
  }
}
</script>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("../drought_code_yvr/01-wrangle.r")  ## read data
source("../drought_code_yvr/02-90th.r")  ## data wrangling
source("../drought_code_yvr/03-heatdays.r")  ## heat wave analysis
source("../drought_code_yvr/04-exceedance.r")  ## heat wave analysis 2

source("../drought_code_yvr/05-dryperiods.r") ## dry periods analysis

source("../drought_code_yvr/06-diffwith90th.r") # Average difference with 90th by month,based on 1961-1990

source("../drought_code_yvr/07-5dayprecip.r") ## 5 day precipitation

source("../drought_code_yvr/08-drydays.r") 
source("../drought_code_yvr/09-plot.r")
source("../drought_code_yvr/diff_station_dry_cor.r") 
# start_year <- 1937
# end_year <- 2024
```


<h1 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> Read data</b>
</h1>
<div style="display:none;"> 



</div>
<h3 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> YVR</b>
</h3>
<div style="display:none;">  
```{r, echo=FALSE,warning=FALSE,message=FALSE,results = 'hide'}

# Call the function with the path to your CSV file
temp_precip_path<- process_data("../output/YVR_raw_filtered_columns.csv","YVR")

percentiles90th_path<- process_base_years(temp_precip_path,"YVR")


result_hw <- process_heat_periods(temp_precip_path, percentiles90th_path, "YVR")
# result_hw$q90_csv_path
# result_hw$heatwave_csv_path


heatwave_csv_path_2 <- process_heat_exceedances(temp_precip_path, percentiles90th_path, "YVR")

```

```{r, echo=FALSE,warning=FALSE,message=FALSE}

# Extract dry periods
periods_dry_path <- extract_dry_periods(temp_precip_path, "YVR")


result_diff <- compute_avg_difference_90th(temp_precip_path, percentiles90th_path, "YVR")
result_diff$avg_exc_by_month
result_diff$diff_over_90th

max5d_precip_bymonth_path <- compute_cumulative_precip(temp_precip_path, "YVR")


```


```{r, echo=FALSE,warning=FALSE,message=FALSE}
imputed_temp_data <- impute_temps(temp_precip_path)
consec_precip_bymonth_path <- calculate_max_consec(imputed_temp_data, "YVR")
```

</div>
<h4 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> plot nexc with year-month</b>
</h4>
<div style="display:none;">
```{r, echo=FALSE,warning=FALSE,message=FALSE}
plot_consecutive_dry_days(consec_precip_bymonth_path, start_year = 1940, end_year = 2024, step = 10)
```
</div>
<h4 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b>Plot avg exc </b>
</h4>
<div style="display:none;">  
```{r, echo=FALSE,warning=FALSE,message=FALSE,fig.width=15, fig.height=6}
heatwave_csv_path_2 <- process_heat_exceedances(temp_precip_path, percentiles90th_path, "YVR")
heatwave_data <- read.csv(heatwave_csv_path_2)
plot_avg_temp_change(heatwave_data)
```

















</div>
<h3 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> Kelowna</b>
</h3>
<div style="display:none;"> 

```{r, echo=FALSE,warning=FALSE,message=FALSE}

# Call the function with the path to your CSV file
temp_precip_path<- process_data("../output/Kelowna_raw_filtered_columns.csv","Kelowna")

percentiles90th_path<- process_base_years(temp_precip_path,"Kelowna")

imputed_temp_data <- impute_temps(temp_precip_path)

consec_precip_bymonth_path_Kelowna <- calculate_max_consec(imputed_temp_data, "Kelowna")
```


</div>
<h4 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> plot nexc with year-month</b>
</h4>
<div style="display:none;">  
#### Plot the consecutive dry days for Kelowna, starting from 1940, Kelowna has data from 1899 to 2024.
```{r, echo=FALSE,warning=FALSE,message=FALSE}
plot_consecutive_dry_days(consec_precip_bymonth_path_Kelowna, start_year = 1940, end_year = 2024, step = 10)

```



</div>
<h4 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b>Plot avg exc </b>
</h4>
<div style="display:none;">  
```{r, echo=FALSE,warning=FALSE,message=FALSE,fig.width=15, fig.height=6}
heatwave_csv_path_2 <- process_heat_exceedances(temp_precip_path, percentiles90th_path, "Kelowna")
heatwave_data <- read.csv(heatwave_csv_path_2)
plot_avg_temp_change(heatwave_data)
```


</div>
<h3 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> Prince George</b>
</h3>
<div style="display:none;"> 

```{r, echo=FALSE,warning=FALSE,message=FALSE}

# Call the function with the path to your CSV file
temp_precip_path<- process_data("../output/Prince_George_raw_filtered_columns.csv","Prince_George")
percentiles90th_path<- process_base_years(temp_precip_path,"Prince_George")

imputed_temp_data <- impute_temps(temp_precip_path)

consec_precip_bymonth_path_pg <- calculate_max_consec(imputed_temp_data, "Prince_George")
```

</div>
<h4 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> plot nexc with year-month</b>
</h4>
<div style="display:none;">  
```{r, echo=FALSE,warning=FALSE,message=FALSE}
plot_consecutive_dry_days(consec_precip_bymonth_path_pg, start_year = 1940, end_year = 2024, step = 10)

```

</div>
<h4 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b>Plot avg exc </b>
</h4>
<div style="display:none;">  
```{r, echo=FALSE,warning=FALSE,message=FALSE,fig.width=15, fig.height=6}
heatwave_csv_path_2 <- process_heat_exceedances(temp_precip_path, percentiles90th_path, "Prince_George")
heatwave_data <- read.csv(heatwave_csv_path_2)
plot_avg_temp_change(heatwave_data)
```


</div>
<h3 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> FortNelson</b>
</h3>
<div style="display:none;"> 

```{r, echo=FALSE,warning=FALSE,message=FALSE}

# Call the function with the path to your CSV file
temp_precip_path<- process_data("../output/FortNelson_raw_filtered_columns.csv","FortNelson")
percentiles90th_path<- process_base_years(temp_precip_path,"FortNelson")

imputed_temp_data <- impute_temps(temp_precip_path)

consec_precip_bymonth_path_fn <- calculate_max_consec(imputed_temp_data, "FortNelson")

```

</div>
<h4 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> plot nexc with year-month</b>
</h4>
<div style="display:none;">  
```{r, echo=FALSE,warning=FALSE,message=FALSE}
plot_consecutive_dry_days(consec_precip_bymonth_path_fn, start_year = 1940, end_year = 2024, step = 10)

```

</div>
<h4 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b>Plot avg exc </b>
</h4>
<div style="display:none;">  
```{r, echo=FALSE,warning=FALSE,message=FALSE,fig.width=15, fig.height=6}
heatwave_csv_path_2 <- process_heat_exceedances(temp_precip_path, percentiles90th_path, "FortNelson")
heatwave_data <- read.csv(heatwave_csv_path_2)
plot_avg_temp_change(heatwave_data)
```


</div>
<h3 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> Abbotsford</b>
</h3>
<div style="display:none;"> 

```{r, echo=FALSE,warning=FALSE,message=FALSE}

# Call the function with the path to your CSV file
temp_precip_path<- process_data("../output/Abbotsford_raw_filtered_columns.csv","Abbotsford")

percentiles90th_path<- process_base_years(temp_precip_path,"Abbotsford")

imputed_temp_data <- impute_temps(temp_precip_path)

consec_precip_bymonth_path_abb <- calculate_max_consec(imputed_temp_data, "Abbotsford")
```

</div>
<h4 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> plot nexc with year-month</b>
</h4>
<div style="display:none;">  
```{r, echo=FALSE,warning=FALSE,message=FALSE}
plot_consecutive_dry_days(consec_precip_bymonth_path_abb, start_year = 1940, end_year = 2024, step = 10)

```

</div>
<h4 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b>Plot avg exc </b>
</h4>
<div style="display:none;">  
```{r, echo=FALSE,warning=FALSE,message=FALSE,fig.width=15, fig.height=6}
heatwave_csv_path_2 <- process_heat_exceedances(temp_precip_path, percentiles90th_path, "Abbotsford")
heatwave_data <- read.csv(heatwave_csv_path_2)
plot_avg_temp_change(heatwave_data)
```






</div>
<h1 onclick="toggleCollapsible(this);">
<!--TEXT SHOWS: -->
<b> Correlation </b>
</h1>
<div style="display:none;"> 
```{r, echo=FALSE,warning=FALSE,message=FALSE}
#consec_precip_bymonth_path_Kelowna
plot_ccf_max_consec(consec_precip_bymonth_path_Kelowna,1899,"Kelowna",
                    consec_precip_bymonth_path,1937,"YVR")
```
#### The maximum cross-correlation at lag -0.75 indicates a relatively stronger relationship when Kelowna's data leads YVR's data by 0.75 time units.


```{r, echo=FALSE,warning=FALSE,message=FALSE}
plot_scatter <- function(data_1_path,data1_start_year,station1, 
                                data_2_path,data2_start_year,station2,extreme_range) {
  # Load the data
  data_1 <- read_csv(data_1_path)
  data_2 <- read_csv(data_2_path)
  data_1$year <- as.integer(substr(data_1$yrmon, 1, 4))
  data_2$year <- as.integer(substr(data_2$yrmon, 1, 4))
  #filter year
  data_1 <- data_1 %>% filter(year >= data1_start_year)
  data_2 <- data_2 %>% filter(year >= data2_start_year)
  
  # Merge the datasets on yrmon
  df_merged <- merge(data_1, data_2, by = c("yrmon"), suffixes = c("_1", "_2"))
  
  
  # Identify the range of extreme points based on the highest temperatures
      top_extremes <- df_merged %>%
        arrange(desc(max_consec_1 + max_consec_2)) %>%
        slice(extreme_range) %>%
        #mutate(label = paste(Year, DayOfYear, sep = "-"))
        mutate(label = paste(yrmon, sep = "-"))
      # Add the dataframe to the list
      #label_dataframes[[paste(station1, station2, sep = "_vs_")]] <- top_extremes
      
      # Create a color palette for the labels
      base_colors <- c('#FF0000', '#008000', '#0000FF', '#000000', '#FF00FF', '#FFA500', '#FFD700', '#D2691E',
                 '#D2B48C', '#808000', '#FFFF00', '#40E0D0', '#00BFFF', '#1E90FF', '#8A2BE2', '#FF1493',
                 '#A52A2A', '#7FFF00', '#8B008B', '#FF69B4','#A9A9A9', '#696969') 
      # Create scatter plot with text annotations and color for top extremes
      plot <- ggplot(df_merged, aes(x = max_consec_1, y = max_consec_2)) +
        geom_point() +
        geom_point(data = top_extremes, aes(x = max_consec_1, y = max_consec_2, color = label), size = 1.5) +
        scale_color_manual(values = base_colors) +
        geom_abline(slope = 1, intercept = 0, linetype = "solid", color = "red", size = 1) +  # Add 45-degree line
        labs(
          title = paste("Scatter Plot of Max Temperature:", station1, "vs", station2),
          x = paste("Max Temperature (", station1, ")", sep = ""),
          y = paste("Max Temperature (", station2, ")", sep = "")
        ) +
        theme_minimal()
      print(plot)
      
      
}

#consec_precip_bymonth_path_fn

plot_scatter(consec_precip_bymonth_path_Kelowna,1937,"Kelowna",
                    consec_precip_bymonth_path,1937,"YVR",1:19)
```


```{r, echo=FALSE,warning=FALSE,message=FALSE}
# Define the stations and their respective file paths and start years
stations <- list(
  
  Abbotsford = list(path = consec_precip_bymonth_path_abb, start_year = 1935),
  FortNelson = list(path = consec_precip_bymonth_path_fn, start_year = 1937),
  PrinceGeorge = list(path = consec_precip_bymonth_path_pg, start_year = 1940),
  Kelowna = list(path = consec_precip_bymonth_path_Kelowna, start_year = 1899),
  YVR = list(path = consec_precip_bymonth_path, start_year = 1937)
)

# Iterate over station pairs and generate scatter plots
station_names <- names(stations)
for (i in 1:(length(station_names) - 1)) {
  for (j in (i + 1):length(station_names)) {
    station1 <- station_names[i]
    station2 <- station_names[j]
    data_1_path <- stations[[station1]]$path
    data_2_path <- stations[[station2]]$path
    data1_start_year <- stations[[station1]]$start_year
    data2_start_year <- stations[[station2]]$start_year
    
    plot_scatter(data_1_path, data1_start_year, station1, data_2_path, data2_start_year, station2,1:19)
  }
}
```
